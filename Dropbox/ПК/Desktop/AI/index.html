<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø–æ—Ä—Ç—Ä–µ—Ç—ã –≤ —Å—Ç–∏–ª–µ –†–µ—á–∏ –ü–æ—Å–ø–æ–ª–∏—Ç–æ–π –∏ –í–µ–ª–∏–∫–æ–≥–æ –ö–Ω—è–∂–µ—Å—Ç–≤–∞ –õ–∏—Ç–æ–≤—Å–∫–æ–≥–æ">
    <title>‚öúÔ∏è –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B8860B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="–ò—Å—Ç–æ—Ä–ü–æ—Ä—Ç—Ä–µ—Ç">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">

    <!-- TensorFlow.js –∏ BodyPix –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.1/dist/body-pix.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: radial-gradient(ellipse at top left, rgba(101, 67, 33, 0.08) 0%, transparent 50%), radial-gradient(ellipse at bottom right, rgba(139, 69, 19, 0.12) 0%, transparent 60%), linear-gradient(135deg, #050302 0%, #0a0805 25%, #1a0f0a 50%, #0a0805 75%, #050302 100%);
            color: #F8F0E6;
            font-family: 'Cinzel', serif;
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
            position: relative;
        }
        /* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ */
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: linear-gradient(90deg, rgba(184, 134, 11, 0.05) 1px, transparent 1px), linear-gradient(rgba(184, 134, 11, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 450px;
            margin: 0 auto;
            background: linear-gradient(145deg, rgba(15, 10, 8, 0.95) 0%, rgba(25, 18, 12, 0.95) 100%), radial-gradient(circle at center, rgba(139, 69, 19, 0.1) 0%, transparent 70%);
            border-radius: 20px;
            padding: 25px;
            border: 4px solid #DAA520;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.9), inset 0 2px 0 rgba(255, 215, 0, 0.4), 0 0 40px rgba(218, 165, 32, 0.5), inset 0 0 30px rgba(101, 67, 33, 0.2);
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            pointer-events: none;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
        }
        
        .royal-crown {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #FFD700 0%, #DAA520 50%, #B8860B 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 15px;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5), inset 0 2px 10px rgba(255, 255, 255, 0.3), 0 0 20px rgba(218, 165, 32, 0.4);
            border: 4px solid #FFD700;
            position: relative;
        }
        
        .royal-crown::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 50%;
        }
        
        h1 {
            font-family: 'Cinzel Decorative', serif;
            font-size: 28px;
            font-weight: 700;
            color: #FFE55C;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 1), 1px 1px 0 rgba(139, 69, 19, 0.8), -1px -1px 0 rgba(139, 69, 19, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            margin-bottom: 8px;
            filter: drop-shadow(0 0 8px rgba(255, 229, 92, 0.4));
        }
        
        .subtitle {
            font-size: 14px;
            color: #F0E6DA;
            font-style: italic;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9), 1px 1px 0 rgba(101, 67, 33, 0.6);
            font-weight: 500;
        }
        
        .period-badges {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            border: 2px solid #DAA520;
            background: linear-gradient(135deg, rgba(15, 10, 8, 0.9) 0%, rgba(25, 18, 12, 0.9) 100%);
            color: #FFE55C;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 1), 1px 1px 0 rgba(139, 69, 19, 0.8);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 215, 0, 0.3);
        }
        
        .step {
            display: block;
        }
        
        .step.hidden {
            display: none;
        }
        
        .upload-area {
            border: 3px dashed #DAA520;
            border-radius: 15px;
            padding: 35px 20px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.4s ease;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(10, 8, 5, 0.8) 0%, rgba(20, 15, 10, 0.8) 100%);
            position: relative;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 215, 0, 0.2);
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
        }
        
        .upload-area:hover {
            background: rgba(45, 31, 21, 0.8);
            border-color: #FFD700;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(184, 134, 11, 0.3);
        }
        
        .upload-area.active {
            background: rgba(255, 215, 0, 0.1);
            border-color: #FFD700;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-icon {
            font-size: 40px;
            margin-bottom: 12px;
            display: block;
            color: #B8860B;
        }
        
        .upload-area p {
            color: #F8F0E6;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9), 1px 1px 0 rgba(101, 67, 33, 0.6);
            font-weight: 500;
        }
        
        .btn,
        .secondary-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .btn {
            background: linear-gradient(145deg, #DAA520, #FFD700);
            color: #0a0805;
            box-shadow: 0 10px 20px rgba(184, 134, 11, 0.5), inset 0 2px 0 rgba(255, 255, 255, 0.4), 0 0 15px rgba(255, 215, 0, 0.3);
            border: 3px solid #FFE55C;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            font-weight: 700;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(184, 134, 11, 0.6), inset 0 2px 0 rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 215, 0, 0.4);
            background: linear-gradient(145deg, #FFD700, #FFE55C);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(145deg, #4a3d2f, #6b5b47);
            border-color: #8B7355;
        }
        
        .secondary-btn {
            background: linear-gradient(135deg, rgba(15, 10, 8, 0.9) 0%, rgba(25, 18, 12, 0.9) 100%);
            color: #F8F0E6;
            border: 3px solid #DAA520;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9), 1px 1px 0 rgba(101, 67, 33, 0.6);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 215, 0, 0.2);
        }
        
        .secondary-btn:hover {
            background: linear-gradient(135deg, rgba(25, 18, 12, 1) 0%, rgba(35, 28, 18, 1) 100%);
            border-color: #FFE55C;
            color: #FFE55C;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 215, 0, 0.3), 0 0 15px rgba(255, 229, 92, 0.2);
        }
        
        .roles-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        
        .role-card {
            background: linear-gradient(135deg, rgba(10, 8, 5, 0.8) 0%, rgba(20, 15, 10, 0.8) 100%);
            border: 3px solid #DAA520;
            border-radius: 12px;
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 215, 0, 0.2);
        }
        
        .role-card::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 6px;
            right: 6px;
            bottom: 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            pointer-events: none;
        }
        
        .role-card:hover {
            background: linear-gradient(135deg, rgba(20, 15, 10, 0.9) 0%, rgba(30, 22, 15, 0.9) 100%);
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(184, 134, 11, 0.4), inset 0 1px 0 rgba(255, 215, 0, 0.3), 0 0 20px rgba(218, 165, 32, 0.3);
            border-color: #FFE55C;
        }
        
        .role-card.selected {
            border-color: #FFE55C;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 229, 92, 0.15) 100%);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.5), inset 0 2px 0 rgba(255, 215, 0, 0.4), 0 8px 20px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
        
        .role-icon {
            font-size: 28px;
            margin-bottom: 8px;
            display: block;
        }
        
        .role-card h3 {
            font-size: 13px;
            margin-bottom: 4px;
            color: #FFE55C;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 1), 1px 1px 0 rgba(139, 69, 19, 0.8), 0 0 8px rgba(255, 229, 92, 0.4);
            filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.3));
        }
        
        .role-card p {
            font-size: 11px;
            color: #F0E6DA;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 1), 1px 1px 0 rgba(101, 67, 33, 0.6);
            font-weight: 500;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: linear-gradient(135deg, rgba(10, 8, 5, 0.9) 0%, rgba(20, 15, 10, 0.9) 100%);
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
            border: 3px solid #DAA520;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 215, 0, 0.2);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #DAA520, #FFD700, #FFE55C);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 3px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .status-text {
            text-align: center;
            margin: 15px 0;
            color: #F8F0E6;
            font-style: italic;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 1), 1px 1px 0 rgba(101, 67, 33, 0.6);
            font-weight: 500;
            font-size: 15px;
        }
        
        .result-canvas {
            width: 100%;
            max-width: 320px;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 215, 0, 0.3);
            border: 4px solid #B8860B;
        }
        
        .social-share {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .social-share button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
            border: 2px solid #B8860B;
        }
        
        .share-download {
            background: linear-gradient(145deg, #8B4513, #A0522D);
            color: #F8F0E6;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 1), 1px 1px 0 rgba(101, 67, 33, 0.6);
            border: 3px solid #DAA520;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 215, 0, 0.2);
        }
        
        .share-download:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(101, 67, 33, 0.5), inset 0 1px 0 rgba(255, 215, 0, 0.3), 0 0 15px rgba(218, 165, 32, 0.3);
            border-color: #FFE55C;
            background: linear-gradient(145deg, #A0522D, #CD853F);
        }
        
        .share-link {
            background: linear-gradient(145deg, #654321, #8B4513);
            color: #F8F0E6;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 1), 1px 1px 0 rgba(101, 67, 33, 0.6);
            border: 3px solid #DAA520;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 215, 0, 0.2);
        }
        
        .share-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 69, 19, 0.5), inset 0 1px 0 rgba(255, 215, 0, 0.3), 0 0 15px rgba(184, 134, 11, 0.3);
            border-color: #FFE55C;
            background: linear-gradient(145deg, #8B4513, #A0522D);
        }
        /* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —É–≥–ª—ã */
        
        .decorative-corners {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #FFD700;
        }
        
        .decorative-corners.top-left {
            top: 15px;
            left: 15px;
            border-right: none;
            border-bottom: none;
        }
        
        .decorative-corners.top-right {
            top: 15px;
            right: 15px;
            border-left: none;
            border-bottom: none;
        }
        
        .decorative-corners.bottom-left {
            bottom: 15px;
            left: 15px;
            border-right: none;
            border-top: none;
        }
        
        .decorative-corners.bottom-right {
            bottom: 15px;
            right: 15px;
            border-left: none;
            border-top: none;
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.4), transparent);
            animation: shimmer 2s infinite;
        }
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
        
        h2 {
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 1), 1px 1px 0 rgba(139, 69, 19, 0.8), 0 0 12px rgba(255, 215, 0, 0.5);
            color: #FFE55C !important;
            filter: drop-shadow(0 0 6px rgba(255, 229, 92, 0.3));
        }
        /* –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        
        .btn:focus,
        .secondary-btn:focus,
        .role-card:focus {
            outline: 3px solid #FFD700;
            outline-offset: 2px;
        }
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è */
        
        @media (max-width: 480px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            .roles-grid {
                gap: 10px;
            }
            .role-card {
                padding: 15px 8px;
            }
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="decorative-corners top-left"></div>
        <div class="decorative-corners top-right"></div>
        <div class="decorative-corners bottom-left"></div>
        <div class="decorative-corners bottom-right"></div>

        <div class="header">
            <div class="royal-crown">‚öúÔ∏è</div>
            <h1>–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç</h1>
            <p class="subtitle">–†–µ—á—å –ü–æ—Å–ø–æ–ª–∏—Ç–∞—è ‚Ä¢ –í–µ–ª–∏–∫–æ–µ –ö–Ω—è–∂–µ—Å—Ç–≤–æ –õ–∏—Ç–æ–≤—Å–∫–æ–µ</p>
            <div class="period-badges">
                <span class="badge">‚öîÔ∏è XVI-XVII –≤–µ–∫</span>
                <span class="badge">üëë 6 —Ä–æ–ª–µ–π</span>
                <span class="badge">ü§ñ AI —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è</span>
                <span class="badge">üéØ –õ—é–±–æ–π —Ñ–æ–Ω</span>
            </div>
        </div>

        <!-- –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
        <div id="step-upload" class="step">
            <h2 style="text-align: center; margin-bottom: 25px; font-family: 'Cinzel Decorative', serif; color: #FFD700;">üìú –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –ª–∏–∫</h2>

            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <span class="upload-icon">üñºÔ∏è</span>
                <p><strong>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ —Å —á–µ–ª–æ–≤–µ–∫–æ–º</strong></p>
                <p style="opacity: 0.8; margin-top: 5px; font-style: italic;">AI –∏–∑–≤–ª–µ—á–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ –ª—é–±–æ–≥–æ —Ñ–æ–Ω–∞</p>
                <p style="opacity: 0.6; margin-top: 8px; font-size: 11px;">JPG, PNG ‚Ä¢ –î–æ 5MB ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º —Ñ–æ–Ω–æ–º</p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept="image/*">
            <button id="nextToRoles" class="btn" disabled>–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å ‚öîÔ∏è</button>
        </div>

        <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä —Ä–æ–ª–∏ -->
        <div id="step-roles" class="step hidden">
            <h2 style="text-align: center; margin-bottom: 25px; font-family: 'Cinzel Decorative', serif; color: #FFD700;">‚öîÔ∏è –ò–∑–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é —Ä–æ–ª—å</h2>
            <div class="roles-grid">
                <div class="role-card" data-role="hussar">
                    <span class="role-icon">üèá</span>
                    <h3>–ö—Ä—ã–ª–∞—Ç—ã–π –≥—É—Å–∞—Ä</h3>
                    <p>–≠–ª–∏—Ç–Ω–∞—è –∫–∞–≤–∞–ª–µ—Ä–∏—è</p>
                </div>
                <div class="role-card" data-role="boyar">
                    <span class="role-icon">üëë</span>
                    <h3>–õ–∏—Ç–æ–≤—Å–∫–∏–π –±–æ—è—Ä–∏–Ω</h3>
                    <p>–ó–Ω–∞—Ç–Ω—ã–π –¥–≤–æ—Ä—è–Ω–∏–Ω</p>
                </div>
                <div class="role-card" data-role="blacksmith">
                    <span class="role-icon">üî®</span>
                    <h3>–ö—É–∑–Ω–µ—Ü</h3>
                    <p>–ú–∞—Å—Ç–µ—Ä-—Ä–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫</p>
                </div>
                <div class="role-card" data-role="knight">
                    <span class="role-icon">‚öîÔ∏è</span>
                    <h3>–¢–µ–≤—Ç–æ–Ω—Å–∫–∏–π —Ä—ã—Ü–∞—Ä—å</h3>
                    <p>–ö—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü</p>
                </div>
                <div class="role-card" data-role="merchant">
                    <span class="role-icon">üí∞</span>
                    <h3>–ì–∞–Ω–∑–µ–π—Å–∫–∏–π –∫—É–ø–µ—Ü</h3>
                    <p>–¢–æ—Ä–≥–æ–≤–µ—Ü</p>
                </div>
                <div class="role-card" data-role="peasant">
                    <span class="role-icon">üåæ</span>
                    <h3>–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω</h3>
                    <p>–°–µ–ª—å—Å–∫–∏–π –∂–∏—Ç–µ–ª—å</p>
                </div>
            </div>
            <button id="generateBtn" class="btn" disabled>–°–æ—Ç–≤–æ—Ä–∏—Ç—å –ø–æ—Ä—Ç—Ä–µ—Ç ‚ú®</button>
            <button class="secondary-btn" onclick="goToUpload()">‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç–∏—Ç—å—Å—è</button>
        </div>

        <!-- –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è -->
        <div id="step-generation" class="step hidden">
            <h2 style="text-align: center; margin-bottom: 25px; font-family: 'Cinzel Decorative', serif; color: #FFD700;">üé® –ú–∞—Å—Ç–µ—Ä —Ç–≤–æ—Ä–∏—Ç –ø–æ—Ä—Ç—Ä–µ—Ç...</h2>

            <div class="progress-bar">
                <div id="progress" class="progress-fill" style="width: 0%;"></div>
            </div>
            <p id="status" class="status-text">–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –∫—Ä–∞—Å–æ–∫ –∏ –ø–æ–ª–æ—Ç–Ω–∞...</p>
        </div>

        <!-- –®–∞–≥ 4: –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div id="step-result" class="step hidden">
            <h2 style="text-align: center; margin-bottom: 25px; font-family: 'Cinzel Decorative', serif; color: #FFD700;">üéâ –ü–æ—Ä—Ç—Ä–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</h2>
            <canvas id="resultCanvas" class="result-canvas"></canvas>

            <div class="social-share">
                <button class="share-download" onclick="downloadResult()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="share-link" onclick="shareResult()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            </div>
            <button class="btn" onclick="createNew()">üîÑ –ù–æ–≤—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç</button>
            <button class="secondary-btn" onclick="tryAnother()">üé≤ –ò–Ω–æ–π –æ–±—Ä–∞–∑</button>
        </div>
    </div>

    <script>
        let uploadedImage = null;
        let selectedRole = null;
        let uploadedImageElement = null;
        let bodyPixModel = null;
        let isAIReady = false;

        const roles = {
            hussar: {
                name: '–ö—Ä—ã–ª–∞—Ç—ã–π –≥—É—Å–∞—Ä',
                color: '#8B4513',
                outfit: 'üèá‚öîÔ∏èüõ°Ô∏è',
                background: '#2D1B0E',
                backgrounds: [{
                    name: '–ü–æ–ª–µ –±–∏—Ç–≤—ã',
                    colors: ['#4a3d2f', '#6b5b47', '#8b7355'],
                    scene: 'battlefield'
                }, {
                    name: '–ó–∞–º–∫–æ–≤—ã–π –¥–≤–æ—Ä',
                    colors: ['#5c4d3f', '#7a6b5d', '#8f8073'],
                    scene: 'castle'
                }, {
                    name: '–í–æ–µ–Ω–Ω—ã–π –ª–∞–≥–µ—Ä—å',
                    colors: ['#3d2f1f', '#5c453a', '#6b544a'],
                    scene: 'camp'
                }]
            },
            boyar: {
                name: '–õ–∏—Ç–æ–≤—Å–∫–∏–π –±–æ—è—Ä–∏–Ω',
                color: '#4B0082',
                outfit: 'üëëüíçüó°Ô∏è',
                background: '#1E0D2A',
                backgrounds: [{
                    name: '–¢—Ä–æ–Ω–Ω—ã–π –∑–∞–ª',
                    colors: ['#2f1b69', '#4b2f82', '#654395'],
                    scene: 'throne'
                }, {
                    name: '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞',
                    colors: ['#3d2a1c', '#5c453a', '#7a6048'],
                    scene: 'library'
                }, {
                    name: '–°–∞–¥ —É—Å–∞–¥—å–±—ã',
                    colors: ['#2d4d2d', '#4a6b4a', '#5c8b5c'],
                    scene: 'garden'
                }]
            },
            blacksmith: {
                name: '–ö—É–∑–Ω–µ—Ü',
                color: '#2F4F4F',
                outfit: 'üî®‚öíÔ∏èüî•',
                background: '#0F1515',
                backgrounds: [{
                    name: '–ö—É–∑–Ω–∏—Ü–∞',
                    colors: ['#1c1c1c', '#ff4500', '#ffa500'],
                    scene: 'forge'
                }, {
                    name: '–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è',
                    colors: ['#2f2f2f', '#654321', '#8b4513'],
                    scene: 'workshop'
                }, {
                    name: '–†—É–¥–Ω–∏–∫',
                    colors: ['#1a1a1a', '#4a3d2f', '#6b5b47'],
                    scene: 'mine'
                }]
            },
            knight: {
                name: '–¢–µ–≤—Ç–æ–Ω—Å–∫–∏–π —Ä—ã—Ü–∞—Ä—å',
                color: '#708090',
                outfit: '‚öîÔ∏èüõ°Ô∏è‚õ™',
                background: '#1C1F23',
                backgrounds: [{
                    name: '–°–æ–±–æ—Ä',
                    colors: ['#36454f', '#5c6b73', '#7a8b95'],
                    scene: 'cathedral'
                }, {
                    name: '–ö—Ä–µ–ø–æ—Å—Ç—å',
                    colors: ['#4a4a4a', '#6b6b6b', '#8b8b8b'],
                    scene: 'fortress'
                }, {
                    name: '–ú–æ–Ω–∞—Å—Ç—ã—Ä—å',
                    colors: ['#3d3d3d', '#5c5c5c', '#7a7a7a'],
                    scene: 'monastery'
                }]
            },
            merchant: {
                name: '–ì–∞–Ω–∑–µ–π—Å–∫–∏–π –∫—É–ø–µ—Ü',
                color: '#8B0000',
                outfit: 'üí∞üíéüè∫',
                background: '#2A0808',
                backgrounds: [{
                    name: '–¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥—å',
                    colors: ['#5c1a1a', '#8b2f2f', '#a54545'],
                    scene: 'market'
                }, {
                    name: '–ü–æ—Ä—Ç',
                    colors: ['#2a3a4a', '#4a5a6a', '#6a7a8a'],
                    scene: 'port'
                }, {
                    name: '–°–∫–ª–∞–¥',
                    colors: ['#3d2a1c', '#5c453a', '#7a6048'],
                    scene: 'warehouse'
                }]
            },
            peasant: {
                name: '–ö—Ä–µ—Å—Ç—å—è–Ω–∏–Ω',
                color: '#8B4513',
                outfit: 'üåæüß∫üè†',
                background: '#2D1B0E',
                backgrounds: [{
                    name: '–ü–æ–ª–µ',
                    colors: ['#4a2c2a', '#6b453a', '#8b6348'],
                    scene: 'field'
                }, {
                    name: '–î–µ—Ä–µ–≤–Ω—è',
                    colors: ['#3d2f1f', '#5c453a', '#7a6048'],
                    scene: 'village'
                }, {
                    name: '–õ–µ—Å',
                    colors: ['#2d4d2d', '#4a6b4a', '#5c8b5c'],
                    scene: 'forest'
                }]
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è BodyPix –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
        async function initializeBodyPix() {
            try {
                console.log('ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TensorFlow.js BodyPix...');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å BodyPix
                bodyPixModel = await bodyPix.load({
                    architecture: 'MobileNetV1',
                    outputStride: 16,
                    multiplier: 0.75,
                    quantBytes: 2
                });

                console.log('‚úÖ BodyPix –≥–æ—Ç–æ–≤!');
                isAIReady = true;

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BodyPix:', error);
                isAIReady = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ —á–µ–ª–æ–≤–µ–∫–∞ —Å –ø–æ–º–æ—â—å—é BodyPix
        async function segmentPersonWithBodyPix(imageElement) {
            try {
                if (!isAIReady || !bodyPixModel) {
                    console.log('‚ö†Ô∏è BodyPix –Ω–µ –≥–æ—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                    return null;
                }

                console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º BodyPix —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é...');

                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = imageElement.width;
                tempCanvas.height = imageElement.height;
                tempCtx.drawImage(imageElement, 0, 0);

                // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é —Å –ø–æ–º–æ—â—å—é BodyPix
                const segmentation = await bodyPixModel.segmentPerson(tempCanvas, {
                    flipHorizontal: false,
                    internalResolution: 'medium',
                    segmentationThreshold: 0.5
                });

                console.log('üéØ BodyPix —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');

                // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
                const maskCanvas = document.createElement('canvas');
                const maskCtx = maskCanvas.getContext('2d');
                maskCanvas.width = segmentation.width;
                maskCanvas.height = segmentation.height;

                // –°–æ–∑–¥–∞–µ–º ImageData –¥–ª—è –º–∞—Å–∫–∏
                const maskImageData = maskCtx.createImageData(segmentation.width, segmentation.height);

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
                for (let i = 0; i < segmentation.data.length; i++) {
                    const pixelIndex = i * 4;
                    const personPixel = segmentation.data[i]; // 1 –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, 0 –¥–ª—è —Ñ–æ–Ω–∞

                    // –ë–µ–ª—ã–π –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, —á–µ—Ä–Ω—ã–π –¥–ª—è —Ñ–æ–Ω–∞
                    const value = personPixel ? 255 : 0;
                    maskImageData.data[pixelIndex] = value; // R
                    maskImageData.data[pixelIndex + 1] = value; // G
                    maskImageData.data[pixelIndex + 2] = value; // B
                    maskImageData.data[pixelIndex + 3] = 255; // A
                }

                maskCtx.putImageData(maskImageData, 0, 0);

                return {
                    originalImage: imageElement,
                    segmentationMask: maskCanvas,
                    segmentationData: segmentation.data,
                    width: segmentation.width,
                    height: segmentation.height
                };

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ BodyPix —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏:', error);
                return null;
            }
        }

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.querySelector('.upload-area');
        const nextButton = document.getElementById('nextToRoles');

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ö†Ô∏è –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage = e.target.result;

                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    uploadedImageElement = new Image();
                    uploadedImageElement.onload = function() {
                        uploadArea.innerHTML = `
                            <span class="upload-icon">‚úÖ</span>
                            <p><strong>–ü–æ—Ä—Ç—Ä–µ—Ç –ø—Ä–∏–Ω—è—Ç!</strong></p>
                            <p style="opacity: 0.8; font-style: italic;">${file.name}</p>
                        `;
                        uploadArea.classList.add('shimmer');
                        nextButton.disabled = false;

                        setTimeout(() => {
                            uploadArea.classList.remove('shimmer');
                        }, 2000);
                    };
                    uploadedImageElement.src = uploadedImage;
                };
                reader.readAsDataURL(file);
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('active');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('active');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // Navigation
        nextButton.addEventListener('click', function() {
            document.getElementById('step-upload').classList.add('hidden');
            document.getElementById('step-roles').classList.remove('hidden');
        });

        function goToUpload() {
            document.getElementById('step-roles').classList.add('hidden');
            document.getElementById('step-upload').classList.remove('hidden');
        }

        // Role selection
        document.querySelectorAll('.role-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedRole = this.dataset.role;
                document.getElementById('generateBtn').disabled = false;

                // –í–∏–±—Ä–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
                if (navigator.vibrate) {
                    navigator.vibrate(75);
                }
            });
        });

        // Generate portrait
        document.getElementById('generateBtn').addEventListener('click', function() {
            document.getElementById('step-roles').classList.add('hidden');
            document.getElementById('step-generation').classList.remove('hidden');
            generatePortrait();
        });

        async function generatePortrait() {
            const statusEl = document.getElementById('status');
            const progressEl = document.getElementById('progress');

            const stages = [{
                progress: 10,
                text: '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...'
            }, {
                progress: 25,
                text: 'AI —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —á–µ–ª–æ–≤–µ–∫–∞...'
            }, {
                progress: 45,
                text: '–°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ–Ω–∞...'
            }, {
                progress: 65,
                text: '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ —Ñ–æ–Ω–∞...'
            }, {
                progress: 85,
                text: '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤...'
            }, {
                progress: 95,
                text: '–§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è...'
            }, {
                progress: 100,
                text: '–ü–æ—Ä—Ç—Ä–µ—Ç –≥–æ—Ç–æ–≤!'
            }];

            for (const stage of stages) {
                statusEl.textContent = stage.text;
                progressEl.style.width = stage.progress + '%';
                await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 600));
            }

            createHistoricalResult();
        }

        async function createHistoricalResult() {
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 600;

            const role = roles[selectedRole];
            const selectedBg = role.backgrounds[Math.floor(Math.random() * role.backgrounds.length)];

            // –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ–Ω–∞
            const backgroundImage = await createHistoricalBackground(ctx, canvas, selectedBg, selectedRole);

            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º AI —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é
            if (uploadedImageElement) {
                await processImageWithAISegmentation(ctx, canvas, uploadedImageElement, backgroundImage, role);
            }

            // –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Ä–∞–º–∫–∞ –æ–±—â–∞—è
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 8;
            ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);

            // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–∞–º–∫–∞
            ctx.strokeStyle = '#B8860B';
            ctx.lineWidth = 4;
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);

            // –£–≥–ª–æ–≤—ã–µ —É–∫—Ä–∞—à–µ–Ω–∏—è
            const corners = [{
                x: 30,
                y: 30
            }, {
                x: canvas.width - 30,
                y: 30
            }, {
                x: 30,
                y: canvas.height - 30
            }, {
                x: canvas.width - 30,
                y: canvas.height - 30
            }];

            ctx.fillStyle = '#FFD700';
            corners.forEach(corner => {
                ctx.beginPath();
                ctx.arc(corner.x, corner.y, 6, 0, Math.PI * 2);
                ctx.fill();

                // –í–Ω–µ—à–Ω–µ–µ –∫–æ–ª—å—Ü–æ
                ctx.strokeStyle = '#B8860B';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(corner.x, corner.y, 10, 0, Math.PI * 2);
                ctx.stroke();
            });

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–æ–ª–∏
            ctx.fillStyle = '#FFD700';
            ctx.strokeStyle = '#0a0505';
            ctx.lineWidth = 2;
            ctx.font = 'bold 26px "Cinzel Decorative", serif';
            ctx.textAlign = 'center';
            ctx.strokeText(role.name, canvas.width / 2, 50);
            ctx.fillText(role.name, canvas.width / 2, 50);

            // –°–∏–º–≤–æ–ª—ã —Ä–æ–ª–∏
            ctx.font = '30px serif';
            ctx.fillStyle = '#FFD700';
            ctx.fillText(role.outfit, canvas.width / 2, 480);

            // –ü–æ–¥–ø–∏—Å—å —ç–ø–æ—Ö–∏
            ctx.font = '16px "Cinzel", serif';
            ctx.fillStyle = '#F4E4BC';
            ctx.strokeStyle = '#0a0505';
            ctx.lineWidth = 1;
            ctx.strokeText('XVI-XVII –≤–µ–∫', canvas.width / 2, 510);
            ctx.fillText('XVI-XVII –≤–µ–∫', canvas.width / 2, 510);
            ctx.strokeText('–†–µ—á—å –ü–æ—Å–ø–æ–ª–∏—Ç–∞—è', canvas.width / 2, 535);
            ctx.fillText('–†–µ—á—å –ü–æ—Å–ø–æ–ª–∏—Ç–∞—è', canvas.width / 2, 535);

            // –ü–æ–¥–ø–∏—Å—å –∞–≤—Ç–æ—Ä–∞ (–≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫)
            ctx.font = '12px "Cinzel", serif';
            ctx.fillStyle = 'rgba(244, 228, 188, 0.6)';
            ctx.fillText('–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –º–∞—Å—Ç–µ—Ä—Å–∫–∞—è', canvas.width / 2, canvas.height - 20);

            // –≠—Ñ—Ñ–µ–∫—Ç —Å—Ç–∞—Ä–µ–Ω–∏—è –ø–æ –∫—Ä–∞—è–º
            ctx.globalAlpha = 0.2;
            const ageGradient = ctx.createRadialGradient(canvas.width / 2, canvas.height / 2, 0, canvas.width / 2, canvas.height / 2, canvas.width / 1.5);
            ageGradient.addColorStop(0, 'transparent');
            ageGradient.addColorStop(1, 'rgba(45, 31, 21, 0.8)');
            ctx.fillStyle = ageGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 1;

            document.getElementById('step-generation').classList.add('hidden');
            document.getElementById('step-result').classList.remove('hidden');
        }

        async function createHistoricalBackground(ctx, canvas, bgConfig, role) {
            console.log(`üé® –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω –¥–ª—è —Ä–æ–ª–∏: ${role}`);

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è —Ñ–æ–Ω–∞
            const bgCanvas = document.createElement('canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = canvas.width;
            bgCanvas.height = canvas.height;

            // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const bgImage = await loadBackgroundImage(role);

            if (bgImage) {
                console.log(`üñºÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –†–ï–ê–õ–¨–ù–´–ô —Ñ–æ–Ω: ${bgImage.width}x${bgImage.height}`);
                // –†–∏—Å—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ–Ω–∞
                drawRealBackground(bgCtx, bgCanvas, bgImage, bgConfig);
            } else {
                console.log(`üé≠ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ü–†–û–¶–ï–î–£–†–ù–´–ô —Ñ–æ–Ω`);
                // Fallback: —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–π —Ñ–æ–Ω
                drawProceduralBackground(bgCtx, bgCanvas, bgConfig);
            }

            // –ö–æ–ø–∏—Ä—É–µ–º —Ñ–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π canvas
            ctx.drawImage(bgCanvas, 0, 0);

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º canvas —Å —Ñ–æ–Ω–æ–º –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            return bgCanvas;
        }

        async function loadBackgroundImage(role) {
            // –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Ñ–∞–π–ª–æ–≤
            const roleFileMap = {
                'peasant': '–∫—Ä–µ—Å—Ç—å—è–Ω–∏–Ω.jpg',
                'hussar': '–≥—É—Å–∞—Ä.jpg',
                'boyar': '–±–æ—è—Ä–∏–Ω.jpg',
                'blacksmith': '–∫—É–∑–Ω–µ—Ü.jpg',
                'knight': '—Ä—ã—Ü–∞—Ä—å.jpg',
                'merchant': '–∫—É–ø–µ—Ü.jpg'
            };

            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ (ASCII)
            const roleFileMapASCII = {
                'peasant': 'peasant.jpg',
                'hussar': 'hussar.jpg',
                'boyar': 'boyar.jpg',
                'blacksmith': 'blacksmith.jpg',
                'knight': 'knight.jpg',
                'merchant': 'merchant.jpg'
            };

            const fileName = roleFileMap[role];
            const fileNameASCII = roleFileMapASCII[role];
            console.log(`üîç –ò—â–µ–º —Ñ–æ–Ω –¥–ª—è —Ä–æ–ª–∏: ${role} ‚Üí —Ñ–∞–π–ª—ã: ${fileName} –∏–ª–∏ ${fileNameASCII}`);

            if (!fileName && !fileNameASCII) {
                console.log(`‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å: ${role}`);
                return null;
            }

            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
            const filesToTry = [fileName, fileNameASCII].filter(Boolean);

            for (const currentFile of filesToTry) {
                try {
                    console.log(`üìÇ –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å: background/${currentFile}`);

                    const img = await new Promise((resolve, reject) => {
                        const image = new Image();

                        image.onload = () => {
                            console.log(`‚úÖ –£–°–ü–ï–®–ù–û –∑–∞–≥—Ä—É–∂–µ–Ω —Ñ–æ–Ω: background/${currentFile}`);
                            console.log(`üìè –†–∞–∑–º–µ—Ä—ã —Ñ–æ–Ω–∞: ${image.width}x${image.height}`);
                            resolve(image);
                        };

                        image.onerror = (error) => {
                            console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: background/${currentFile}`);
                            reject(error);
                        };

                        image.src = `background/${currentFile}`;
                    });

                    return img; // –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏

                } catch (error) {
                    console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${currentFile}:`, error);
                    continue; // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª
                }
            }

            console.log('üîÑ –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é');
            return null;
        }

        function drawRealBackground(ctx, canvas, bgImage, bgConfig) {
            // –†–∏—Å—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –º–∞—Å—à—Ç–∞–±–∏—Ä—É—è –ø–æ–¥ canvas
            const scale = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
            const scaledWidth = bgImage.width * scale;
            const scaledHeight = bgImage.height * scale;
            const offsetX = (canvas.width - scaledWidth) / 2;
            const offsetY = (canvas.height - scaledHeight) / 2;

            ctx.drawImage(bgImage, offsetX, offsetY, scaledWidth, scaledHeight);

            // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä –ø–æ–≤–µ—Ä—Ö —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            ctx.globalCompositeOperation = 'multiply';
            ctx.globalAlpha = 0.6;

            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            bgConfig.colors.forEach((color, i) => {
                gradient.addColorStop(i / (bgConfig.colors.length - 1), color + '80');
            });
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É —Ä–µ–∂–∏–º—É
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É —Å—Ç–∞—Ä–∏–Ω—ã
            addVintageTexture(ctx, canvas);
        }

        function drawProceduralBackground(ctx, canvas, bgConfig) {
            // –°–æ–∑–¥–∞–µ–º –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—ã–π –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–π —Ñ–æ–Ω (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            bgConfig.colors.forEach((color, i) => {
                gradient.addColorStop(i / (bgConfig.colors.length - 1), color);
            });

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É —Å—Ç–∞—Ä–∏–Ω—ã
            addVintageTexture(ctx, canvas);

            // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å—Ü–µ–Ω—ã
            addSceneElements(ctx, canvas, bgConfig.scene);
        }

        function addVintageTexture(ctx, canvas) {
            ctx.globalAlpha = 0.15;
            for (let i = 0; i < 300; i++) {
                const brightness = Math.random() * 100;
                ctx.fillStyle = `rgba(${brightness}, ${brightness * 0.8}, ${brightness * 0.6}, 0.1)`;
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
            }
            ctx.globalAlpha = 1;
        }

        async function processImageWithAISegmentation(ctx, canvas, userImage, backgroundCanvas, role) {
            console.log('ü§ñ –ù–∞—á–∏–Ω–∞–µ–º AI —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é...');

            // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å BodyPix –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
            let segmentationResult = null;
            if (isAIReady) {
                try {
                    console.log('üéØ –ò—Å–ø–æ–ª—å–∑—É—é BodyPix –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏');
                    segmentationResult = await segmentPersonWithBodyPix(userImage);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ BodyPix:', error);
                }
            }

            if (segmentationResult) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç BodyPix
                await processImageWithAIMask(ctx, canvas, userImage, backgroundCanvas, segmentationResult, role);
            } else {
                // Fallback –∫ –∞–ª–≥–æ—Ä–∏—Ç–º—É –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞
                console.log('üîÑ Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞');
                await processImageWithBackgroundReplacement(ctx, canvas, userImage, backgroundCanvas, role);
            }
        }

        async function processImageWithAIMask(ctx, canvas, userImage, backgroundCanvas, segmentationResult, role) {
            console.log('üé® –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å BodyPix –º–∞—Å–∫–æ–π');

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ canvas –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 400;
            tempCanvas.height = 500;

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const scale = Math.min(tempCanvas.width / userImage.width, tempCanvas.height / userImage.height);
            const scaledWidth = userImage.width * scale;
            const scaledHeight = userImage.height * scale;
            const offsetX = (tempCanvas.width - scaledWidth) / 2;
            const offsetY = (tempCanvas.height - scaledHeight) / 2;

            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas
            tempCtx.drawImage(userImage, offsetX, offsetY, scaledWidth, scaledHeight);

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∏–∫—Å–µ–ª–µ–π
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;

            // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ BodyPix
            const mask = new Uint8ClampedArray(tempCanvas.width * tempCanvas.height);

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –Ω–∞—à–µ–≥–æ canvas
            const segWidth = segmentationResult.width;
            const segHeight = segmentationResult.height;
            const segData = segmentationResult.segmentationData;

            for (let y = 0; y < tempCanvas.height; y++) {
                for (let x = 0; x < tempCanvas.width; x++) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ –Ω–∞—à–µ–≥–æ canvas –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
                    const segX = Math.floor((x - offsetX) * segWidth / scaledWidth);
                    const segY = Math.floor((y - offsetY) * segHeight / scaledHeight);

                    const pixelIndex = y * tempCanvas.width + x;

                    if (segX >= 0 && segX < segWidth && segY >= 0 && segY < segHeight) {
                        const segIndex = segY * segWidth + segX;
                        // BodyPix –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1 –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞, 0 –¥–ª—è —Ñ–æ–Ω–∞
                        mask[pixelIndex] = segData[segIndex] ? 255 : 0;
                    } else {
                        // –ó–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - —Å—á–∏—Ç–∞–µ–º —Ñ–æ–Ω–æ–º
                        mask[pixelIndex] = 0;
                    }
                }
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫ –º–∞—Å–∫–µ
            const smoothedMask = applySmoothingToMask(mask, tempCanvas.width, tempCanvas.height);

            // –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
            await composeImageWithMask(ctx, canvas, tempCanvas, backgroundCanvas, data, smoothedMask, role);
        }

        async function composeImageWithMask(ctx, canvas, tempCanvas, backgroundCanvas, imageData, smoothedMask, role) {
            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const resultCanvas = document.createElement('canvas');
            const resultCtx = resultCanvas.getContext('2d');
            resultCanvas.width = tempCanvas.width;
            resultCanvas.height = tempCanvas.height;

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ–Ω–∞
            const bgCanvas = document.createElement('canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = tempCanvas.width;
            bgCanvas.height = tempCanvas.height;

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Ñ–æ–Ω –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const bgScale = Math.max(tempCanvas.width / backgroundCanvas.width, tempCanvas.height / backgroundCanvas.height);
            const bgScaledWidth = backgroundCanvas.width * bgScale;
            const bgScaledHeight = backgroundCanvas.height * bgScale;
            const bgOffsetX = (tempCanvas.width - bgScaledWidth) / 2;
            const bgOffsetY = (tempCanvas.height - bgScaledHeight) / 2;

            bgCtx.drawImage(backgroundCanvas, bgOffsetX, bgOffsetY, bgScaledWidth, bgScaledHeight);
            const backgroundData = bgCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);

            // –°–º–µ—à–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ñ–æ–Ω–æ–º –∏—Å–ø–æ–ª—å–∑—É—è –º–∞—Å–∫—É
            const resultData = resultCtx.createImageData(tempCanvas.width, tempCanvas.height);

            for (let i = 0; i < imageData.length; i += 4) {
                const pixelIndex = Math.floor(i / 4);
                const maskValue = smoothedMask[pixelIndex] / 255; // –û—Ç 0 –¥–æ 1

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userR = imageData[i];
                const userG = imageData[i + 1];
                const userB = imageData[i + 2];

                // –°–µ–ø–∏—è —ç—Ñ—Ñ–µ–∫—Ç
                const sepiaR = Math.min(255, (userR * 0.393) + (userG * 0.769) + (userB * 0.189));
                const sepiaG = Math.min(255, (userR * 0.349) + (userG * 0.686) + (userB * 0.168));
                const sepiaB = Math.min(255, (userR * 0.272) + (userG * 0.534) + (userB * 0.131));

                // –¶–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
                const bgR = backgroundData.data[i];
                const bgG = backgroundData.data[i + 1];
                const bgB = backgroundData.data[i + 2];

                // –°–º–µ—à–∏–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑—É—è –º–∞—Å–∫—É
                resultData.data[i] = sepiaR * maskValue + bgR * (1 - maskValue);
                resultData.data[i + 1] = sepiaG * maskValue + bgG * (1 - maskValue);
                resultData.data[i + 2] = sepiaB * maskValue + bgB * (1 - maskValue);
                resultData.data[i + 3] = 255;
            }

            resultCtx.putImageData(resultData, 0, 0);

            // –†–∏—Å—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º canvas
            const portraitX = 50;
            const portraitY = 80;
            const portraitWidth = 300;
            const portraitHeight = 350;

            ctx.save();
            ctx.beginPath();
            ctx.roundRect(portraitX, portraitY, portraitWidth, portraitHeight, 10);
            ctx.clip();

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω—É—é –æ–±–ª–∞—Å—Ç—å
            const portraitScale = Math.max(portraitWidth / resultCanvas.width, portraitHeight / resultCanvas.height);
            const finalWidth = resultCanvas.width * portraitScale;
            const finalHeight = resultCanvas.height * portraitScale;
            const finalX = portraitX + (portraitWidth - finalWidth) / 2;
            const finalY = portraitY + (portraitHeight - finalHeight) / 2;

            ctx.drawImage(resultCanvas, finalX, finalY, finalWidth, finalHeight);
            ctx.restore();

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—É—é —Ä–∞–º–∫—É
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 4;
            ctx.strokeRect(portraitX - 2, portraitY - 2, portraitWidth + 4, portraitHeight + 4);

            ctx.strokeStyle = '#B8860B';
            ctx.lineWidth = 2;
            ctx.strokeRect(portraitX - 6, portraitY - 6, portraitWidth + 12, portraitHeight + 12);

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–∫—É—é –ø–∞—Ç–∏–Ω—É
            ctx.globalAlpha = 0.15;
            const patina = ctx.createLinearGradient(portraitX, portraitY, portraitX + portraitWidth, portraitY + portraitHeight);
            patina.addColorStop(0, 'rgba(139, 69, 19, 0.3)');
            patina.addColorStop(1, 'rgba(184, 134, 11, 0.3)');
            ctx.fillStyle = patina;
            ctx.fillRect(portraitX, portraitY, portraitWidth, portraitHeight);
            ctx.globalAlpha = 1;
        }

        async function processImageWithBackgroundReplacement(ctx, canvas, userImage, backgroundCanvas, role) {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ canvas –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 400;
            tempCanvas.height = 500;

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const scale = Math.min(tempCanvas.width / userImage.width, tempCanvas.height / userImage.height);
            const scaledWidth = userImage.width * scale;
            const scaledHeight = userImage.height * scale;
            const offsetX = (tempCanvas.width - scaledWidth) / 2;
            const offsetY = (tempCanvas.height - scaledHeight) / 2;

            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas
            tempCtx.drawImage(userImage, offsetX, offsetY, scaledWidth, scaledHeight);

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∏–∫—Å–µ–ª–µ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;

            // –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞
            const mask = new Uint8ClampedArray(tempCanvas.width * tempCanvas.height);

            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞
            const whiteThreshold = 240; // –ü–æ—Ä–æ–≥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–µ–ª–æ–≥–æ (–æ—Ç 240 –¥–æ 255)
            const tolerance = 15; // –î–æ–ø—É—Å—Ç–∏–º–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ

            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∏–∫—Å–µ–ª—è–º –∏ —Å–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const alpha = data[i + 3];

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∏–∫—Å–µ–ª—å –±–µ–ª—ã–º –∏–ª–∏ –±–ª–∏–∑–∫–∏–º –∫ –±–µ–ª–æ–º—É
                const isWhiteish = (
                    alpha > 200 && // –ü–∏–∫—Å–µ–ª—å –Ω–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
                    r >= whiteThreshold - tolerance &&
                    g >= whiteThreshold - tolerance &&
                    b >= whiteThreshold - tolerance &&
                    Math.abs(r - g) < tolerance &&
                    Math.abs(r - b) < tolerance &&
                    Math.abs(g - b) < tolerance
                );

                const pixelIndex = Math.floor(i / 4);
                mask[pixelIndex] = isWhiteish ? 0 : 255; // 0 = –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–æ–Ω, 255 = –æ—Å—Ç–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫ –º–∞—Å–∫–µ (blur effect)
            const smoothedMask = applySmoothingToMask(mask, tempCanvas.width, tempCanvas.height);

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
            await composeImageWithMask(ctx, canvas, tempCanvas, backgroundCanvas, data, smoothedMask, role);
        }

        function applySmoothingToMask(mask, width, height) {
            const smoothed = new Uint8ClampedArray(mask.length);
            const kernelSize = 2; // –†–∞–∑–º–µ—Ä —è–¥—Ä–∞ –¥–ª—è —Ä–∞–∑–º—ã—Ç–∏—è

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let sum = 0;
                    let count = 0;

                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ
                    for (let ky = -kernelSize; ky <= kernelSize; ky++) {
                        for (let kx = -kernelSize; kx <= kernelSize; kx++) {
                            const nx = x + kx;
                            const ny = y + ky;

                            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                sum += mask[ny * width + nx];
                                count++;
                            }
                        }
                    }

                    smoothed[y * width + x] = sum / count;
                }
            }

            return smoothed;
        }

        function addSceneElements(ctx, canvas, scene) {
            ctx.globalAlpha = 0.2;
            ctx.fillStyle = 'rgba(139, 69, 19, 0.3)';

            switch (scene) {
                case 'battlefield':
                    // –°–∏–ª—É—ç—Ç—ã –∑–Ω–∞–º–µ–Ω
                    for (let i = 0; i < 3; i++) {
                        const x = Math.random() * canvas.width;
                        const y = canvas.height * 0.3;
                        drawFlag(ctx, x, y);
                    }
                    break;

                case 'castle':
                    // –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    drawCastleElements(ctx, canvas);
                    break;

                case 'forge':
                    // –≠—Ñ—Ñ–µ–∫—Ç –æ–≥–Ω—è –∏ –∏—Å–∫—Ä
                    drawForgeEffects(ctx, canvas);
                    break;

                case 'cathedral':
                    // –ì–æ—Ç–∏—á–µ—Å–∫–∏–µ –∞—Ä–∫–∏
                    drawCathedralArches(ctx, canvas);
                    break;

                case 'forest':
                    // –°–∏–ª—É—ç—Ç—ã –¥–µ—Ä–µ–≤—å–µ–≤
                    drawTreeSilhouettes(ctx, canvas);
                    break;
            }
            ctx.globalAlpha = 1;
        }

        function drawFlag(ctx, x, y) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y - 60);
            ctx.lineTo(x + 40, y - 45);
            ctx.lineTo(x, y - 30);
            ctx.fill();
        }

        function drawCastleElements(ctx, canvas) {
            // –ü—Ä–æ—Å—Ç—ã–µ —Å–∏–ª—É—ç—Ç—ã –±–∞—à–µ–Ω
            ctx.fillRect(canvas.width * 0.1, canvas.height * 0.4, 30, canvas.height * 0.3);
            ctx.fillRect(canvas.width * 0.8, canvas.height * 0.3, 25, canvas.height * 0.4);
        }

        function drawForgeEffects(ctx, canvas) {
            // –ò–º–∏—Ç–∞—Ü–∏—è –∏—Å–∫—Ä –∏ –æ–≥–Ω—è
            ctx.fillStyle = 'rgba(255, 69, 0, 0.4)';
            for (let i = 0; i < 10; i++) {
                const x = Math.random() * canvas.width;
                const y = canvas.height * 0.7 + Math.random() * 100;
                ctx.beginPath();
                ctx.arc(x, y, Math.random() * 3 + 1, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawCathedralArches(ctx, canvas) {
            // –ì–æ—Ç–∏—á–µ—Å–∫–∏–µ –∞—Ä–∫–∏
            ctx.strokeStyle = 'rgba(139, 69, 19, 0.3)';
            ctx.lineWidth = 3;
            for (let i = 0; i < 2; i++) {
                const x = canvas.width * (0.3 + i * 0.4);
                ctx.beginPath();
                ctx.arc(x, canvas.height * 0.6, 40, Math.PI, 0);
                ctx.stroke();
            }
        }

        function drawTreeSilhouettes(ctx, canvas) {
            // –°–∏–ª—É—ç—Ç—ã –¥–µ—Ä–µ–≤—å–µ–≤
            for (let i = 0; i < 4; i++) {
                const x = Math.random() * canvas.width;
                const height = 60 + Math.random() * 40;

                // –°—Ç–≤–æ–ª
                ctx.fillRect(x - 2, canvas.height * 0.6, 4, height);

                // –ö—Ä–æ–Ω–∞
                ctx.beginPath();
                ctx.arc(x, canvas.height * 0.6 - height + 20, 20, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function downloadResult() {
            const canvas = document.getElementById('resultCanvas');
            const link = document.createElement('a');
            link.download = `historical-portrait-${selectedRole}-${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();

            // –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function shareResult() {
            const canvas = document.getElementById('resultCanvas');

            if (navigator.share && navigator.canShare) {
                canvas.toBlob(blob => {
                    const file = new File([blob], 'historical-portrait.png', {
                        type: 'image/png'
                    });
                    if (navigator.canShare({
                            files: [file]
                        })) {
                        navigator.share({
                            title: '–ú–æ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç',
                            text: `–Ø —Å–æ–∑–¥–∞–ª –ø–æ—Ä—Ç—Ä–µ—Ç –≤ —Ä–æ–ª–∏ "${roles[selectedRole].name}" –≤ —ç–ø–æ—Ö—É –†–µ—á–∏ –ü–æ—Å–ø–æ–ª–∏—Ç–æ–π!`,
                            files: [file]
                        }).catch(console.error);
                    }
                });
            } else {
                // –†–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
                navigator.clipboard.writeText(window.location.href)
                    .then(() => alert('üìã –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!'))
                    .catch(() => alert('üîó –°—Å—ã–ª–∫–∞: ' + window.location.href));
            }
        }

        function createNew() {
            uploadedImage = null;
            uploadedImageElement = null;
            selectedRole = null;
            document.getElementById('step-result').classList.add('hidden');
            document.getElementById('step-upload').classList.remove('hidden');
            document.getElementById('nextToRoles').disabled = true;
            document.getElementById('generateBtn').disabled = true;
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));

            // –°–±—Ä–æ—Å –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            document.querySelector('.upload-area').innerHTML = `
                <span class="upload-icon">üñºÔ∏è</span>
                <p><strong>–ü—Ä–∏–∫–æ—Å–Ω–∏—Ç–µ—Å—å –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–∞</strong></p>
                <p style="opacity: 0.8; margin-top: 5px; font-style: italic;">–∏–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</p>
                <p style="opacity: 0.6; margin-top: 8px; font-size: 11px;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: JPG, PNG ‚Ä¢ –î–æ 5MB</p>
            `;

            // –°–±—Ä–æ—Å –ø–æ–ª—è —Ñ–∞–π–ª–∞
            document.getElementById('fileInput').value = '';
        }

        function tryAnother() {
            document.getElementById('step-result').classList.add('hidden');
            document.getElementById('step-generation').classList.remove('hidden');
            generatePortrait();
        }

        // –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
        if ('ontouchstart' in window) {
            document.body.style.webkitUserSelect = 'none';
            document.body.style.webkitTouchCallout = 'none';
        }

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑—É–º–∞ –Ω–∞ iOS
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è BodyPix –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', async() => {
            console.log('‚öúÔ∏è –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç v5.1 - BodyPix Edition');
            console.log('üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º TensorFlow.js BodyPix...');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º BodyPix
            await initializeBodyPix();

            if (isAIReady) {
                console.log('ü§ñ BodyPix AI —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞!');
                console.log('üéØ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª—é–±—ã—Ö —Ñ–æ–Ω–æ–≤ —Å BodyPix');
                console.log('üîÑ Fallback –∫ –∞–ª–≥–æ—Ä–∏—Ç–º—É –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö');
            } else {
                console.log('‚ö†Ô∏è BodyPix –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞');
            }

            console.log('üé® –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–æ–Ω–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ background/');
            console.log('üåæ –§–æ–Ω –∫—Ä–µ—Å—Ç—å—è–Ω–∏–Ω–∞: background/–∫—Ä–µ—Å—Ç—å—è–Ω–∏–Ω.jpg');
            console.log('‚ú® –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫—Ä–∞–µ–≤ –∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã');
            console.log('üëë –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–æ–∫–∞–ª—å–Ω–æ');
        });
    </script>
</body>

</html>